variables:
  # When using DinD service, we need to instruct docker, to talk with
  # the daemon started inside of the service. The daemon is available
  # with a network connection instead of the default /var/run/docker.sock socket.
  DOCKER_HOST: "tcp://docker:2375"

.base-helm:
  image: dtzar/helm-kubectl:3.3.1
  tags:
    - docker
    - privileged
  only:
    - merge_requests
    - master

.base-jsonnet:
  image: docker:18.09
  tags:
    - docker
    - privileged
  only:
    - merge_requests
    - master
  services:
    - docker:18.09-dind

stages:
  - build jsonnet
  - build helm
  - test
  - publish

build jsonnet dashboards:
  stage: build jsonnet
  extends: .base-jsonnet
  script:
    # Generate YAML files from jsonnet templates
    - docker run -u `id -u` --rm -t -v `pwd`:/src dnationcloud/jsonnet:latest jsonnet -c -m chart/templates/k8s-monitoring -S jsonnet/helm.jsonnet
    # Pretty print of generated YAML files - some escape characters provided by jsonnet build need to be removed to achieve valid HELM template format.
    # Pretty print is not yet supported by jsonnet library, see https://github.com/google/jsonnet/issues/821
    - find ./chart/templates/k8s-monitoring/ -type f -regex '.*\.yaml' -print |  while read f; do docker run -u `id -u` --rm -t -v `pwd`:/src dnationcloud/jsonnet:latest yq r -P "$f" > "$f"_tmp && mv "$f"_tmp "$f" || exit 1; done;
  artifacts:
    paths:
    - chart/templates/k8s-monitoring

build helm package:
  stage: build helm
  extends: .base-helm
  script:
    - helm package -u -d chart/release chart
  artifacts:
    paths:
    - chart/release/

test lint:
  stage: test
  extends: .base-helm
  script:
    - helm lint chart -f chart/values.yaml

test lint jsonnet:
  stage: test
  extends: .base-jsonnet
  script:
  - find ./jsonnet/ -type f -regex '.*\.\(libsonnet\|jsonnet\)' -print |  while read f; do docker run -u `id -u` --rm -t -v `pwd`:/src dnationcloud/jsonnet:latest jsonnet-lint "$f" || exit 1; done;

publish:
  stage: publish
  image: cfmanteiga/alpine-bash-curl-jq
  only:
    - master
  script:
    - curl --fail --user "$IFNE_HELM_USER":"$IFNE_HELM_PASS" "$IFNE_HELM_URL" --upload-file chart/release/dnation-kubernetes-monitoring-*.tgz
  when: manual
